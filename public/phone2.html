<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Phone 2</title>
</head>
<body>
  <h1>Phone 2</h1>
  <audio id="remoteAudio" autoplay></audio>

  <script>
    const ws = new WebSocket("wss://sesl-gorusme.onrender.com/ws");
    let pc;
    let localStream;
    let heartbeatInterval;

    async function init() {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

      pc = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.relay.metered.ca:80" },
          { urls: "turn:standard.relay.metered.ca:80", username: "d648d4967e580d04e7c7b9be", credential: "evt4C7YBa+aWhUrI" },
          { urls: "turn:standard.relay.metered.ca:80?transport=tcp", username: "d648d4967e580d04e7c7b9be", credential: "evt4C7YBa+aWhUrI" },
          { urls: "turn:standard.relay.metered.ca:443", username: "d648d4967e580d04e7c7b9be", credential: "evt4C7YBa+aWhUrI" },
          { urls: "turns:standard.relay.metered.ca:443?transport=tcp", username: "d648d4967e580d04e7c7b9be", credential: "evt4C7YBa+aWhUrI" }
        ]
      });

      pc.ontrack = (event) => {
        document.getElementById("remoteAudio").srcObject = event.streams[0];
      };

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.onicecandidate = (event) => {
        if (event.candidate) ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
      };

      ws.onmessage = async (msg) => {
        const data = JSON.parse(msg.data);

        if (data.type === "offer") {
          await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: "answer", answer }));
        } else if (data.type === "candidate") {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        } else if (data.type === "pong") {
          console.log("âœ… Pong alÄ±ndÄ±, baÄŸlantÄ± canlÄ±.");
        }
      };
    }

    ws.onopen = async () => {
      await init();

      // ğŸ”¹ Heartbeat: her 10 saniyede bir ping gÃ¶nder
      heartbeatInterval = setInterval(() => {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "ping" }));
        }
      }, 10000);
    };

    ws.onclose = () => {
      console.log("âŒ WebSocket kapandÄ±");
      clearInterval(heartbeatInterval);
    };

    ws.onerror = (err) => {
      console.error("âš ï¸ WebSocket hatasÄ±:", err);
    };
  </script>
</body>
</html>
