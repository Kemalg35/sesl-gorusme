<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Phone 2</title>
</head>
<body>
  <h1>Phone 2</h1>
  <audio id="remoteAudio" autoplay></audio>

  <script>
    const ws = new WebSocket("wss://sesl-gorusme.onrender.com/ws");
    let pc;
    let localStream;

    async function init() {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      pc = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { 
            urls: "turn:numb.viagenie.ca",
            username: "webrtc@live.com",
            credential: "muazkh"
          }
        ]
      });

      pc.ontrack = (event) => {
        document.getElementById("remoteAudio").srcObject = event.streams[0];
      };

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.onicecandidate = (event) => {
        if (event.candidate) ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
      };

      ws.onmessage = async (msg) => {
        const data = JSON.parse(msg.data);
        if (data.type === "offer") {
          await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: "answer", answer }));
        } else if (data.type === "answer") {
          await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        } else if (data.type === "candidate") {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      };
    }

    ws.onopen = async () => {
      await init();
      // Phone2 offer olu≈üturmaz, sadece cevap verir
    };
  </script>
</body>
</html>
