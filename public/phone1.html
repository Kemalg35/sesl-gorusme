<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phone1 Panel</title>
<style>
body { font-family: Arial,sans-serif; margin:0; padding:0; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#e0f7fa; }
h1 { color:#004d40; margin-bottom:30px; font-size:28px; text-align:center; }
button { font-size:20px; padding:15px 40px; border:none; border-radius:10px; cursor:pointer; background:#43a047; color:white; margin-bottom:20px; }
#statusText { font-size:22px; font-weight:bold; color:#00695c; margin-top:20px; min-height:30px; text-align:center; transition: all 0.3s; }
</style>
</head>
<body>

<h1>İnterkom Konuşma Paneli</h1>
<button id="startCall">Çağrı Başlat</button>
<div id="statusText"></div>

<script>
const ws = new WebSocket("wss://sesl-gorusme.onrender.com/ws");
const startBtn = document.getElementById('startCall');
const statusText = document.getElementById('statusText');

let callQueue = []; // Kuyruk
let activeCall = false;

// WebSocket açıldı
ws.onopen = ()=> console.log("Phone1 WebSocket bağlandı");

// Kuyruktaki çağrıyı işleme alma
function processQueue(){
    if(activeCall || callQueue.length===0) return;
    activeCall = true;
    const callData = callQueue.shift();

    // Phone2’ye çağrı iletiliyor
    ws.send(JSON.stringify({ type: "incomingCall", payload: callData }));
    statusText.innerText = "OPERATÖR ARANIYOR";
}

// Yeni çağrı ekleme (buton veya ESP)
function addCallToQueue(callInfo = {}){
    callQueue.push(callInfo);
    processQueue();
}

// Butona basınca çağrı ekleme
startBtn.addEventListener('click', ()=> addCallToQueue({from:"Phone1"}));

// ESP’den çağrı geldiğinde ekleme
ws.onmessage = (msg)=>{
    const data = JSON.parse(msg.data);
    if(data.type === "incomingCallFromESP"){ // ESP çağrısı geldi
        addCallToQueue({from:"ESP"});
    } else if(data.type === "callEnded"){ // Phone2 çağrıyı sonlandırdı
        activeCall = false;
        statusText.innerText = "";
        processQueue(); // Kuyruktaki diğer çağrıyı başlat
    }
};
</script>

</body>
</html>
