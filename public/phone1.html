<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phone1 Panel</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; background:#fff8f0; }
  h1 { color:#bf360c; }
  button { font-size:20px; padding:12px 30px; margin:10px; border:none; border-radius:10px; cursor:pointer; }
  #callBtn { background:#43a047; color:white; }
  #endBtn { background:#e53935; color:white; display:none; }
</style>
</head>
<body>

<h1>Phone1 Panel</h1>
<button id="callBtn">Ã‡aÄŸrÄ± BaÅŸlat</button>
<button id="endBtn">GÃ¶rÃ¼ÅŸmeyi SonlandÄ±r</button>

<audio id="remoteAudio" autoplay></audio>

<script>
const ws = new WebSocket("wss://sesl-gorusme.onrender.com/ws");
let pc;
let localStream;

const callBtn = document.getElementById('callBtn');
const endBtn = document.getElementById('endBtn');
const remoteAudio = document.getElementById('remoteAudio');

// ICE Servers
const iceServers = [
  { urls: "stun:stun.relay.metered.ca:80" },
  { urls: "turn:standard.relay.metered.ca:80", username: "d648d4967e580d04e7c7b9be", credential: "evt4C7YBa+aWhUrI" },
  { urls: "turn:standard.relay.metered.ca:443", username: "d648d4967e580d04e7c7b9be", credential: "evt4C7YBa+aWhUrI" }
];

// Ã‡aÄŸrÄ± baÅŸlat
callBtn.onclick = async ()=>{
  ws.send(JSON.stringify({type:"incomingCall"})); // Phone2'ye bildirim
};

// WebSocket mesajlarÄ±
ws.onmessage = async (msg)=>{
  const data = JSON.parse(msg.data);

  // --- Heartbeat cevaplarÄ± ---
  if(data.type === "pong"){
    console.log("Pong alÄ±ndÄ± â†’ baÄŸlantÄ± canlÄ± ðŸ‘");
    return;
  }

  if(data.type === "callAccepted"){
    startCall();
  }

  if(data.type === "answer" && pc){
    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
  }

  if(data.type === "candidate" && pc){
    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
  }

  if(data.type === "callEnded"){
    endCall();
  }
};

// --- Heartbeat: 10 snâ€™de bir ping gÃ¶nder ---
setInterval(()=>{
  if(ws.readyState === WebSocket.OPEN){
    ws.send(JSON.stringify({type:"ping"}));
  }
}, 10000);

// WebRTC baÅŸlat
async function startCall(){
  pc = new RTCPeerConnection({iceServers});
  pc.ontrack = (event)=> { remoteAudio.srcObject = event.streams[0]; };
  pc.onicecandidate = (event)=>{ if(event.candidate) ws.send(JSON.stringify({type:"candidate", candidate:event.candidate})); };

  localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
  localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({type:"offer", offer}));

  callBtn.style.display='none';
  endBtn.style.display='inline-block';
}

// Ã‡aÄŸrÄ±yÄ± sonlandÄ±r
endBtn.onclick = ()=>{
  ws.send(JSON.stringify({type:"callEnded"}));
  endCall();
};

// Ortak temizleme
function endCall(){
  if(pc){
    pc.getSenders().forEach(sender=>sender.track.stop());
    pc.close();
    pc=null;
    localStream=null;
  }
  remoteAudio.srcObject=null;
  callBtn.style.display='inline-block';
  endBtn.style.display='none';
}
</script>
</body>
</html>
